# This is a basic workflow to help you get started with Actions

name: Deploy `marmadilemanteater.dev`

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "development" ]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Allow one concurrent deployment
concurrency:
  group: "marmadilemanteater-dev"
  cancel-in-progress: true

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3

      - name: ⬇ Download SimpleReverseProxy artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          workflow: main.yml 
          workflow_conclusion: success
          branch: development
          path: ./artifacts/
          # only download the version built for OpenSSL 1.1.1f because it is what I am running on my linode
          name: SimpleReverseProxy-openssl1.1.1f
          repo: MarmadileManteater/SimpleReverseProxy
          check_artifacts:  false
          search_artifacts: false
          skip_unpack: false
          if_no_artifact_found: fail
          
      - name: ⬇ Download SvelteKitSite artifact 
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          workflow: main.yml 
          workflow_conclusion: success
          branch: development
          path: .
          repo: MarmadileManteater/SvelteKitSite
          check_artifacts:  false
          search_artifacts: false
          skip_unpack: false
          if_no_artifact_found: fail
      
      - name: 🤐 Unzip SvelteKitSite artifact 
        uses: montudor/action-zip@v1
        with:
          args: unzip -qq MarmadileManteaterSvelte/build.zip -d ./artifacts/
          
      - name: Rename artifact folder
        run: |
          mv ./artifacts/build ./artifacts/sveltekitsite

      - name: ⬇ Download QwikStaticSite artifact 
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          workflow: main.yml 
          workflow_conclusion: success
          branch: development
          path: ./artifacts/public/qwik
          repo: MarmadileManteater/QwikStaticSite
          check_artifacts:  false
          search_artifacts: false
          skip_unpack: false
          if_no_artifact_found: fail

      - name: ⬇ Download AstroVueStaticSite artifact 
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          workflow: main.yml 
          workflow_conclusion: success
          branch: development
          path: ./artifacts/public/astro
          repo: MarmadileManteater/AstroVueStaticSite
          check_artifacts:  false
          search_artifacts: false
          skip_unpack: false
          if_no_artifact_found: fail
          
      - name: 🤐 Zip up artifacts directory for 🏎faster uploads
        uses: montudor/action-zip@v1
        with:
          args: zip -r artifacts.zip ./artifacts
          
      - name: 🏗Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }} 
          known_hosts: 'just-a-placeholder'
    
      - name: Add known hosts
        run: ssh-keyscan -H ${{ secrets.LINODE_IP_ADDRESS }} >> ~/.ssh/known_hosts
        
      - name: 🚀Deploy with scp
        run: scp artifacts.zip ${{ secrets.SSH_USER }}@${{ secrets.LINODE_IP_ADDRESS }}:~/
    
